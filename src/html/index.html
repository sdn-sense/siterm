<!doctype html>
<html lang="en">
  <head>
    <meta name="generator" content="HTML Tidy for HTML5 for Linux version 5.4.0" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="assets/css/bootstrap.css" rel="stylesheet" />
    <link href="assets/css/custom.css" rel="stylesheet" />
    <link rel="stylesheet" href="assets/css/next.css" />
    <script src="assets/js/jquery.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script src="assets/js/main.js" type="text/javascript"></script>
    <script src="assets/js/multiselect.js" type="text/javascript"></script>
    <script type="text/javascript" src="assets/js/next.js"></script>
    <script type="text/javascript">
      google.load("visualization", "1", { packages: ["table", "controls"] });
    </script>
    <title>Site-RM: Frontend Configuration</title>

    <style>
      /* Simple blocking overlay for login */
      #loginOverlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.55);
        display: none;
        z-index: 9999;
      }
      #loginCard {
        max-width: 420px;
        margin: 10vh auto;
      }
    </style>
  </head>

  <body>
    <!-- Login overlay -->
    <div id="loginOverlay">
      <div class="card shadow" id="loginCard">
        <div class="card-body">
          <h5 class="card-title mb-3">Login required</h5>
          <div class="alert alert-danger d-none" id="loginError"></div>

          <div class="mb-3">
            <label for="loginUser" class="form-label">Username</label>
            <input type="text" class="form-control" id="loginUser" autocomplete="username" />
          </div>

          <div class="mb-3">
            <label for="loginPass" class="form-label">Password</label>
            <input type="password" class="form-control" id="loginPass" autocomplete="current-password" />
          </div>

          <button class="btn btn-primary w-100" id="loginBtn">Sign in</button>
          <div class="text-muted mt-2" style="font-size: 0.9em;">
            Token is stored in <code>localStorage</code> and used as <code>Authorization: Bearer</code>.
          </div>
        </div>
      </div>
    </div>

    <header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
      <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="#">SDN SENSE End Site Monitoring</a>
      <div class="ms-auto d-flex align-items-center pe-3" id="status-container">
        <span class="text-success mr-3" id="alive-status">Alive: ...</span>
        <span class="text-success mr-3" id="ready-status">Ready: ...</span>
        <span class="text-success mr-3" id="readiness-status">Readiness: ...</span>
        <span class="text-success mr-3" id="liveness-status">Liveness: ...</span>
        <span class="text-white mr-3" id="swagger-doc"><a href="/docs#/" target="_blank">Swagger Doc</a></span>
        <span class="text-white mr-3" id="prometheus-url"><a href="#" target="_blank">Prometheus Metrics</a></span>
        <span class="text-white mr-3">
          <a href="#" id="logoutLink" class="text-decoration-none">Logout</a>
        </span>
      </div>
    </header>

    <div class="container-fluid">
      <div class="row">
        <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
          <div class="position-sticky pt-3">
            <ul class="nav flex-column">
              <li class="nav-item"><a class="nav-link active" aria-current="page" href="/index.html">Topology</a></li>
              <li class="nav-item"><a class="nav-link" href="/frontendconfig.html">Frontend Configuration</a></li>
              <li class="nav-item"><a class="nav-link" href="/models.html">Models</a></li>
              <li class="nav-item"><a class="nav-link" href="/servicestates.html">ServiceStates</a></li>
              <li class="nav-item"><a class="nav-link" href="/deltas.html">Deltas</a></li>
              <li class="nav-item"><a class="nav-link" href="/activerequests.html">Active Requests</a></li>
            </ul>
            <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
              <span>Debugging tools</span>
              <a class="link-secondary" href="#" aria-label="Debugging tools"></a>
            </h6>
            <ul class="nav flex-column mb-2">
              <li class="nav-item"><a class="nav-link" href="/newdebug.html">Request new debug action</a></li>
              <li class="nav-item"><a class="nav-link" href="/debughistory.html">Debug history</a></li>
              <li class="nav-item"><a class="nav-link" href="/changeactive.html">Change Active Start/End</a></li>
            </ul>
          </div>
        </nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
          <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">Topology</h1>
          </div>

          <div class="row">
            <div class="col">
              <label>Filter switch</label>
              <select name="filterswitch" id="filterswitch" style="width: 220px" multiple multiselect-search="true" multiselect-select-all="true" multiselect-max-items="3" onchange="reload(nx, data)"></select>

              <label>Filter Server</label>
              <select name="filterserver" id="filterserver" style="width: 220px" multiple multiselect-search="true" multiselect-select-all="true" multiselect-max-items="3" onchange="reload(nx, data)"></select>

              <div class="next-app" id="topo"></div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script src="assets/js/bootstrap.bundle.js"></script>
    <script src="assets/js/bootstrap.js"></script>

    <script>
      // ==========================
      // Auth glue for the UI
      // ==========================
      const TOKEN_KEY = "siterm_access_token";

      function getToken() {
        return window.localStorage.getItem(TOKEN_KEY);
      }

      function setToken(tok) {
        window.localStorage.setItem(TOKEN_KEY, tok);
      }

      function clearToken() {
        window.localStorage.removeItem(TOKEN_KEY);
      }

      function showLogin() {
        $("#loginOverlay").show();
      }

      function hideLogin() {
        $("#loginOverlay").hide();
      }

      function showLoginError(msg) {
        $("#loginError").removeClass("d-none").text(msg);
      }

      function setupAjaxAuth() {
        $.ajaxSetup({
          beforeSend: function(xhr) {
            const tok = getToken();
            if (tok) {
              xhr.setRequestHeader("Authorization", "Bearer " + tok);
            }
          }
        });
      }

      async function doLogin(username, password) {
        $("#loginError").addClass("d-none").text("");
        const res = await fetch("/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json", "Accept": "application/json" },
          body: JSON.stringify({ username, password })
        });

        const body = await res.json().catch(() => ({}));
        if (!res.ok) {
          const detail = (body && (body.detail || body.message)) ? (body.detail || body.message) : ("HTTP " + res.status);
          throw new Error(detail);
        }

        if (!body.access_token) {
          throw new Error("Login response missing access_token");
        }

        setToken(body.access_token);
        setupAjaxAuth();
        hideLogin();
      }

      async function doLogout() {
        // Optional: if you add /auth/logout, call it; otherwise local logout is fine.
        clearToken();
        showLogin();
      }

      // Global 401 handler: show login overlay
      $(document).ajaxError(function(_evt, jqxhr) {
        if (jqxhr && jqxhr.status === 401) {
          clearToken();
          showLoginError("Session expired. Please login again.");
          showLogin();
        }
      });

      $(document).ready(function() {
        setupAjaxAuth();

        $("#loginBtn").on("click", async function() {
          const u = $("#loginUser").val();
          const p = $("#loginPass").val();
          try {
            await doLogin(u, p);
            // Reload to re-run data fetches cleanly
            window.location.reload();
          } catch (e) {
            showLoginError(e.message || String(e));
          }
        });

        $("#logoutLink").on("click", function(e) {
          e.preventDefault();
          doLogout();
        });

        if (!getToken()) {
          showLogin();
        }
      });
    </script>

    <script>
      $("#myTab a").click(function (e) {
        e.preventDefault();
        $(this).tab("show");
      });

      var data = {};
      var topologyData = { nodes: [], links: [] };

      var configdata = null;
      $.ajax({
        url: "/api/frontend/configuration",
        dataType: "json",
        async: false,
        success: function (response) {
          configdata = response;
        },
      });

      if (configdata) {
        var sitename = configdata["general"]["sitename"];
        $("#prometheus-url").html(
          '<a href="/api/' + sitename + '/monitoring/prometheus/metrics" target="_blank">Prometheus Metrics</a>',
        );
        $.ajax({
          url: "/api/" + sitename + "/topo/gettopology",
          dataType: "json",
          async: false,
          success: function (json) {
            for (j = 0; j < json.length; j++) {
              var myObject = (0, eval)("(" + json[j]["hostinfo"] + ")");
              json[j]["hostinfo"] = myObject;
            }
            data = json;
          },
        });
      }

      for (var x = Object.keys(data), i = 0; i < x.length, (key = x[i]), (value = data[key]); i++) {
        topologyData["nodes"].push({
          id: value["_id"],
          name: key,
          icontype: value["DeviceInfo"]["type"],
        });
        $("#filter" + value["DeviceInfo"]["type"]).append(
          $("<option>", { value: key, text: key }),
        );
      }
    </script>

    <script>
      function normalizeKey(str) {
        return str.toLowerCase().replace(/\s+/g, "");
      }

      function filterSelect(name) {
        var input = [];
        inputSelect = document.getElementById(name);
        for (i = 0; i < inputSelect.length; i++) {
          item = inputSelect[i];
          if (item.selected) {
            input.push(item.value);
          }
        }
        return input;
      }

      function filterAddItem(item, devtype, filterswitch, filterserver) {
        if (devtype === "switch") {
          if (filterswitch.length === 0) return true;
          return filterswitch.includes(item);
        }
        if (devtype === "server") {
          if (filterserver.length === 0) return true;
          return filterserver.includes(item);
        }
        if (devtype === "cloud") {
          return true;
        }
        return false;
      }

      function loadTopo(nx, data) {
        filterswitch = filterSelect("filterswitch");
        filterserver = filterSelect("filterserver");
        var topologyData = { nodes: [], links: [] };
        links = {};
        tmpid = 0;

        for (var x = Object.keys(data), i = 0; i < x.length, (key = x[i]), (value = data[key]); i++) {
          if (filterAddItem(key, value["DeviceInfo"]["type"], filterswitch, filterserver)) {
            tmpdata = { id: value["_id"], name: key, icontype: value["DeviceInfo"]["type"] };
            if (value["DeviceInfo"]["type"] === "cloud") {
              tmpdata["isAlias"] = value["DeviceInfo"]["name"];
            }
            topologyData["nodes"].push(tmpdata);

            for (var l = Object.keys(data[key]["topo"]), j = 0; j < x.length, (intkey = l[j]), (intval = data[key]["topo"][intkey]); j++) {
              if (filterAddItem(intval["device"], "switch", filterswitch, filterserver) || filterAddItem(intval["device"], "server", filterswitch, filterserver)) {
                linkkey = key + " " + intkey + " " + intval["device"] + " " + intval["port"];
                linkkey = normalizeKey(linkkey);
                linkkey1 = intval["device"] + " " + intval["port"] + " " + key + " " + intkey;
                linkkey1 = normalizeKey(linkkey1);
                if (linkkey in links && linkkey1 in links) {
                  linkid = links[linkkey];
                } else {
                  links[linkkey] = tmpid;
                  links[linkkey1] = tmpid;
                  linkid = tmpid;
                  tmpid++;
                }
                sourceid = value["_id"];
                targetid = data[intval["device"]]["_id"];
                ports = key + ":" + intkey + "<->" + intval["device"] + ":" + intval["port"];
                topologyData["links"].push({ source: sourceid, target: targetid, id: tmpid, ports: ports });
              }
            }
          }
        }

        nx.define("SceneOverride", nx.graphic.Topology.DefaultScene, {
          methods: {
            enterLink: function (sender, link) {
              this.inherited(sender, link);
              link._oldcolor = link._color;
              link.color("#FFFF00");
            },
            leaveLink: function (sender, link) {
              this.inherited(sender, link);
              if (link._oldcolor) {
                link.color(link._oldcolor);
              } else {
                link.color(null);
              }
            },
          },
        });

        nx.define("TopologyContainer", nx.ui.Component, {
          properties: {
            topology: {
              get: function () { return this.view("topology"); },
            },
          },
          view: {
            content: {
              name: "topology",
              type: "nx.graphic.Topology",
              props: {
                adaptive: true,
                nodeConfig: {
                  label: function (vertex) { return vertex.get("name"); },
                  iconType: function (vertex) { return vertex.get("icontype"); },
                },
                linkConfig: { width: 3, linkType: "curve" },
                showIcon: true,
                data: topologyData,
                dataProcessor: "force",
                identityKey: "id",
              },
              events: { topologyGenerated: "{#_main}" },
            },
          },
          methods: {
            _main: function (sender, event) {
              var topo = sender;
              topo.registerScene("myscene", "SceneOverride");
              topo.activateScene("myscene");
            },
          },
        });
      }

      (function (nx, data) {
        loadTopo(nx, data);
      })(nx, data);
    </script>

    <script>
      (function (nx) {
        var app = new nx.ui.Application();
        var topologyContainer = new TopologyContainer();
        var topology = topologyContainer.topology();
        app.container(document.getElementById("topo"));
        topology.attach(app);
      })(nx);

      function reload(nx, data) {
        loadTopo(nx, data);
        var app = new nx.ui.Application();
        var topologyContainer = new TopologyContainer();
        var topology = topologyContainer.topology();
        document.getElementById("topo").innerHTML = "";
        app.container(document.getElementById("topo"));
        topology.attach(app);
      }

      document.addEventListener("DOMContentLoaded", function () {
        fetchStatus();
        setInterval(fetchStatus, 10000);
      });
    </script>
  </body>
</html>
